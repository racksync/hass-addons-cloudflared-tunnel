name: Push to Add-Ons Suite
on:
  push:
    branches: [ main ]
    paths:
      - 'zerotrust/**'
      - 'README.md'
      - '.github/workflows/mono_repo_publish.yaml'

jobs:
  clean-target-directory:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: 'racksync/hass-addons-suite'
        token: ${{ secrets.API_TOKEN_GITHUB }}
        path: 'target-repo'

    - name: Clean entire zerotrust directory
      run: |
        cd target-repo
        if [ -d "zerotrust" ]; then
          echo "üßπ Cleaning entire zerotrust directory..."
          echo "Current contents:"
          ls -la zerotrust/ || true

          # Remove all contents but keep the directory
          rm -rf zerotrust/*
          echo "‚úÖ Cleaned all contents from zerotrust directory"

          git config --local user.email "devops@racksync.com"
          git config --local user.name "racksync"
          git add -A
          git status
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (directory was already clean)"
          else
            git commit -m "üßπ Clean zerotrust directory for fresh update

          - Removed all existing contents before fresh deployment
          - Preparing for consolidated universal add-on deployment
          - Supports all architectures: armhf, armv7, aarch64, amd64, i386"
            git push
            echo "‚úÖ Successfully committed cleanup"
          fi
        else
          echo "‚ÑπÔ∏è zerotrust directory not found, will be created during deployment"
        fi

  push-zerotrust:
    needs: clean-target-directory
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Push zerotrust
      uses: dmnemec/copy_file_to_another_repo_action@main
      env:
        API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
      with:
        source_file: "zerotrust/"
        destination_repo: 'racksync/hass-addons-suite'
        destination_folder: 'zerotrust/'
        user_email: 'devops@racksync.com'
        user_name: 'racksync'
        commit_message: '‚ú® Update zerotrust universal add-on from consolidated codebase'

  push-zerotrust-readme:
    needs: clean-target-directory
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Push README.md
      uses: dmnemec/copy_file_to_another_repo_action@main
      env:
        API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
      with:
        source_file: "README.md"
        destination_repo: 'racksync/hass-addons-suite'
        destination_folder: 'zerotrust/'
        user_email: 'devops@racksync.com'
        user_name: 'racksync'
        commit_message: 'üìù Update zerotrust documentation from consolidated codebase'