name: Push to Add-Ons Suite
on:
  push:
    branches: [ main ]
    paths:
      - 'zerotrust/**'
      - 'README.md'
      - '.github/workflows/mono_repo_publish.yaml'

jobs:
  deploy-to-suite:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: 'racksync/hass-addons-suite'
        token: ${{ secrets.API_TOKEN_GITHUB }}
        path: 'target-repo'

    - name: Clean and deploy
      run: |
        cd target-repo

        echo "ğŸ§¹ Cleaning existing zerotrust directory..."
        if [ -d "zerotrust" ]; then
          echo "Current contents:"
          ls -la zerotrust/ || true
          rm -rf zerotrust/*
          echo "âœ… Cleaned all contents from zerotrust directory"
        else
          mkdir -p zerotrust
          echo "âœ… Created zerotrust directory"
        fi

        echo "ğŸ“ Copying zerotrust add-on files..."
        cp -r ../zerotrust/* zerotrust/
        echo "âœ… Copied zerotrust add-on files"

        echo "ğŸ“„ Copying repository README..."
        cp ../README.md zerotrust/
        echo "âœ… Copied repository README"

        echo "ğŸ” Verifying copied contents:"
        ls -la zerotrust/

    - name: Commit and push changes
      run: |
        cd target-repo
        git config --local user.email "devops@racksync.com"
        git config --local user.name "racksync"

        git add -A
        git status

        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          echo "ğŸ“ Committing changes..."
          git commit -m "ğŸš€ Deploy zerotrust universal add-on

          âœ¨ Features:
          - Universal architecture support (armhf, armv7, aarch64, amd64, i386)
          - Zero Trust security through Cloudflare
          - Token-based and advanced configuration options
          - Complete documentation and troubleshooting guides

          ğŸ§¹ Changes:
          - Cleaned legacy add-on files
          - Fresh deployment of consolidated add-on
          - Updated documentation and configuration

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          Co-Authored-By: Claude <noreply@anthropic.com>"

          echo "ğŸ“¤ Pushing to main branch..."
          git push -u origin HEAD:main
          echo "âœ… Successfully deployed to hass-addons-suite!"
        fi